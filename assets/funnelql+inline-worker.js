/*! FunnelQL v1.0.5
 * (c) https://funnelql.com/ */
!function(l,x){function n(){}function y(a){a=q.indexOf(a);-1!==a&&q.splice(a,1)}function z(a,b,e,d,c){this.constructor.prototype.__proto__=SyntaxError.prototype;SyntaxError.captureStackTrace&&SyntaxError.captureStackTrace(this,this.constructor);this.name="FunnelQL_Error";this.message=a;this.startLine=b;this.startCol=e;this.endLine=d;this.endCol=c;this.toObject=function(){return[1,this.message,this.startLine,this.startCol,this.endLine,this.endCol]}}function p(a,b,e){var d=++E;h.b(d,b);v.postMessage([a,
d,e])}function A(a){return new Promise(function(b){w.href=a;p(2,function(a){b(a);h.c("path",a)},a=w.pathname+w.search)})}if("Promise"in l){l.document;Date.now||(Date.now=function(){return(new Date).getTime()});var h=new (function(a){function b(){}function e(a,b,d){this.fn=a;this.context=b;this.b=d||!1}function d(){this.a=new b;this.f=0}return Object.create&&(b.prototype=Object.create(null),(new b).__proto__||(a=!1)),d.prototype.c=function(c,b,d,e,k,h){var g=a?a+c:c;if(!this.a[g])return!1;var m,f=
this.a[g],r=arguments.length;if(f.fn){switch(f.b&&this.removeListener(c,f.fn,x,!0),r){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,b),!0;case 3:return f.fn.call(f.context,b,d),!0;case 4:return f.fn.call(f.context,b,d,e),!0;case 5:return f.fn.call(f.context,b,d,e,k),!0;case 6:return f.fn.call(f.context,b,d,e,k,h),!0}g=1;for(m=Array(r-1);g<r;g++)m[g-1]=arguments[g];f.fn.apply(f.context,m)}else for(var l,n=f.length,g=0;g<n;g++)switch(f[g].b&&this.removeListener(c,f[g].fn,x,
!0),r){case 1:f[g].fn.call(f[g].context);break;case 2:f[g].fn.call(f[g].context,b);break;case 3:f[g].fn.call(f[g].context,b,d);break;case 4:f[g].fn.call(f[g].context,b,d,e);break;default:if(!m)for(l=1,m=Array(r-1);l<r;l++)m[l-1]=arguments[l];f[g].fn.apply(f[g].context,m)}return!0},d.prototype.on=function(c,b,d){b=new e(b,d||this);c=a?a+c:c;return this.a[c]?this.a[c].fn?this.a[c]=[this.a[c],b]:this.a[c].push(b):(this.a[c]=b,this.f++),this},d.prototype.b=function(c,b,d){b=new e(b,d||this,!0);c=a?a+
c:c;return this.a[c]?this.a[c].fn?this.a[c]=[this.a[c],b]:this.a[c].push(b):(this.a[c]=b,this.f++),this},d.prototype.removeListener=function(c,d,e,h){c=a?a+c:c;if(!this.a[c])return this;if(!d)return 0==--this.f?this.a=new b:delete this.a[c],this;var k=this.a[c];if(k.fn)k.fn!==d||h&&!k.b||e&&k.context!==e||(0==--this.f?this.a=new b:delete this.a[c]);else{for(var m=0,g=[],l=k.length;m<l;m++)(k[m].fn!==d||h&&!k[m].b||e&&k[m].context!==e)&&g.push(k[m]);g.length?this.a[c]=1===g.length?g[0]:g:0==--this.f?
this.a=new b:delete this.a[c]}return this},d.prototype.off=d.prototype.removeListener,d.prototype.addListener=d.prototype.on,d.i=a,d}("~")),q=[];h.on("u",function(){!function(a){isNaN(a)&&(a=!1);for(var b=q.length,e=0;e<b;e++)!1!==a&&e!==a||function(a,b){n.query(b).then(function(c){c&&(h.c("q"+a,c,b),y(b))})}(e,q[e])}()});for(var B=0;64>B;)++B;var t,C,u,D=function(a,b){var e="blue",d="#dfdfdf";switch(b){case "info":e="#afafaf";break;case "error":d=e="red";break;case "warn":d=e="orange"}a.unshift("font-size:12px;font-weight:bold;color:"+
d+";margin-right:1px;");a.unshift("font-size:8px;font-weight:bold;");a.unshift("font-size:12px;font-weight:bold;color:"+e+";margin-right:1px;");a.unshift("font-size:12px;font-weight:bold;color:"+d+";margin-right:1px;");a.unshift("%c\u2772%c\u0192%cQL%c\u2773");console.log.apply(null,a)},E=(l.performance,0);try{var v=new Worker(function(a){var b;try{b=new Blob([a],{type:"application/javascript"})}catch(e){l.BlobBuilder=l.BlobBuilder||l.WebKitBlobBuilder||l.h,(b=new BlobBuilder).append(a),b=b.getBlob("application/javascript")}return URL.createObjectURL(b)}('/*! FunnelQL v1.0.5\n * (c) https://funnelql.com/ */\n!function(z){function Ca(c,b){return new function(){this.name=c;this.startTime=b.startTime;this.duration=b.duration}}function G(c,b){var a,d;if(T&&(T.mark(c),na[c]=1,b&&b in na))return a||(a="_"),a in U?(U[a]++,a+=U[a]):U[a]=1,T.measure(a,b,c),(a=T.getEntriesByName(a))&&a[0]?(d||(d="Perf"),Ca(d,a[0])):""}function A(c,b,a,d){var f="blue",m="#dfdfdf";switch(b){case "info":f="#afafaf";break;case "error":case "nomatch":m=f="red";break;case "match":case "ok":f=m="#079c2d";break;case "warn":m=f="orange"}c.unshift("font-size:12px;font-weight:bold;color:"+\nm+";margin-right:1px;");a&&c.unshift("font-size:8px;font-weight:bold;color:black;");c.unshift("font-size:8px;font-weight:bold;");c.unshift("font-size:12px;font-weight:bold;color:"+f+";margin-right:1px;");c.unshift("font-size:12px;font-weight:bold;color:"+m+";margin-right:1px;");c.unshift("%c\\u2772%c\\u0192%cQL"+(a?"%c "+a:"")+"%c\\u2773");console[d||"log"].apply(null,c)}function E(c){return new Promise(c)}function H(c,b,a,d,f){this.constructor.prototype.__proto__=SyntaxError.prototype;SyntaxError.captureStackTrace&&\nSyntaxError.captureStackTrace(this,this.constructor);this.name="FunnelQL_Parser_Error";this.message=c;this.startLine=b;this.startCol=a;this.endLine=d;this.endCol=f;this.toObject=function(){return[1,this.message,this.startLine,this.startCol,this.endLine,this.endCol]}}function V(c,b){if(c in da)return!!b||da[c];var a,d=c.match(Da);if(d)try{d=new RegExp(d[1],d[2])}catch(f){d=!1,b?a=f.message:q&&CONSOLE_ERROR(f.message,c)}return b?(a||d||(a="Invalid regular expression: Pattern not recognized: "+c),a||\n!!d):!!d&&(da[c]=d)}function W(c,b){var a=X[b];if(a)for(var d=0;d<a.length;++d){if(K[a[d]]||console.error("no token regex",a[d],c,K,b,X),K[a[d]].test(c))return a[d]}else console.error("no regex",b,c,X);return!1}function oa(c){var b=this;return this.string=c,this.query=[],new Promise(function(a,d){var f=function(a,b){function c(a){return a.replace(/\\u2071(\\d+)\\u207f/g,function(a,b){return d[parseInt(b)]})}b.a=[];var d=[];return function(a,f,g){var h,m,l,k,n;f||(f=1);g||(g=1);for(var e=a.match(pa);e;){if(l=\ne[0],-1===(n=a.indexOf(l,e.index)))throw Error("Failed to extract regex "+l);for(var w="(\\u2071"+(d.push(e[1])-1)+"\\u207f)",x=a.indexOf("(",n),p=a.indexOf(")",x+e[1].length);"\\\\"===a.substring(p-1,p);)p=a.indexOf(")",p+1);e=(a=a.substring(0,x)+w+" ".repeat(e[1].length-w.length)+a.substring(p+1)).match(pa)}for(e=a.match(qa);e;){if(l=k=e[0],n=a.indexOf(l,e.index),l.length,-1===n)throw Error("Failed to extract parenthesis "+l);e=a.substring(0,n);if(e.match(Ea)&&-1!==l.indexOf("\\u2090")&&(r=l.match(Fa))&&\nr.forEach(function(a){a=l.match(Ga);l=l.replace(a[0],"("+b.a[parseInt(a[1])][0]+")")}),0===n)h=f,m=g;else{var Q=e.split("\\n");m=g+(e.length-1);h=f;Q.forEach(function(a,b){b<Q.length-1&&(m-=a.length,h++)});m-=Q.length-1}var r,B=k.length;(r=k.match(/\\u2090(\\d+)\\u209c/g))&&r.forEach(function(a){a=a.match(ea);B+=b.a[parseInt(a[1])][3]});w="\\u2090"+(b.a.push([c(l.replace(Ha,"")),h,m,B])-1)+"\\u209c";x=a.indexOf("(",n);for(p=a.indexOf(")",x+(k.length-1));"\\\\"===a.substring(p-1,p);)p=a.indexOf(")",p+1);e=\n(a=a.substring(0,x)+w+" ".repeat(k.length-w.length)+a.substring(p+1)).match(qa)}return c(a)}(a)}(c,b);b.parse(f).then(function(c){M.push([b.string,c]);50<M.length&&(M=M.splice(-50));a(c)})["catch"](d)})}function ra(c){var b;try{var a=JSON.parse(c)}catch(d){b=d.message}if(b||"string"==typeof a||(b="Not a valid JSON string: "+c.toString()),b)throw Error(b);return a}function sa(c){return E(function(b,a){function d(a){if(!h){if(h=1,q&&m){m[1][0].json=JSON.stringify(a);var c=G("_"+f,f);c&&m.push(c.duration,\n"ms");A(m,"ok","Parser")}b(a)}}if(++ta,q){var f="parse"+ta;G(f);var m=["\\u2714",[{fql:c}]]}var h,e=M.length;if(e)for(var r=0;r<e;r++)if(M[r][0]===c)return q&&m&&(m[1][0].cache=!0),d(M[r][1]);(new oa(c)).then(function(a){d(a)})["catch"](function(b){if(!(b instanceof H))throw b;q&&A([b.message],"error","Parser","error");a(b.toObject())})})}function fa(c,b){var a;if(c in t[1]){if((a=t[1][c].slice(0)).tag=c,a.path=a[0][0],a.date=a[1][0],b){var d,f=a[0],m=a[1],h=b.offset||!1;if(b.count){var e=m.length,\nr=!0;switch(b.count[0]){case "<":e<b.count[1]||(r=!1);break;case ">":e>b.count[1]||(r=!1);break;case "<=":e<=b.count[1]||(r=!1);break;case ">=":e>=b.count[1]||(r=!1);break;case "=":e!==b.count[1]&&(r=!1)}if(q&&A(["count",JSON.stringify(c),b.count[0],b.count[1],"( count:",e,")",r],r?"match":"nomatch","Query"),!r)return!1}if(h&&h.path){d=!1;e=0;for(r=f.length;e<r;e++)if(f[e]<h.path){a.path=f[e];d=!0;break}if(!d)return!1}if(h&&h.date){d=!1;e=f.indexOf(a.path);for(r=m.length;e<r;e++)if(m[e]<h.date){a.date=\nm[e];d=!0;break}if(!d)return!1}if((b.minTime||b.maxTime)&&!ua(a[1],b.minTime,b.maxTime))return!1;if(b.pathOffset){var k,w,g,O,I;d=b.pathOffset[0];var e=new Date(1E3*b.pathOffset.date),l=-1,u=!1;b.pathOperator&&(2===(k=b.pathOperator[0]).length&&"|"===k.substring(0,1)&&(w=b.pathOffset.path,d=[b.pathOffset.path],k=k.substring(1)),b.pathOperator[1]&&(b.pathOperator[2]?u=ga(b.pathOperator[1],b.pathOperator[2],e,!0):l=b.pathOperator[1]));var n=0,P=d.length;a:for(;n<P;n++)if(!(h&&h.path&&h.path<=d[n])){var C;\ng=[d[n]];w?g.push(d[n]):-1!==l&&(g[0]++,g.push(d[n]+l));r=f.length;for(e=0;e<r;e++)if(f[e]>=g[0]&&(!g[1]||f[e]<=g[1])&&!(h&&h.date&&h.date>m[e])&&!(h&&h.path&&h.path>f[e]||b.pathOffset.date>m[e]||(C=new Date(1E3*m[e]),b.minTime&&C<b.minTime)||b.maxTime&&C>b.maxTime)){if(u){if("<"===k&&u<C)continue;if(">"===k&&C<u)continue}O=f[e];I=e;break a}}if(!O)return!1;a.path=O;a.date=m[I]}}return a}}function va(c,b){var a,d;for(d in"string"==typeof c&&(c=V(c)),t[1])if(t[1].hasOwnProperty(d)&&c.test(d)&&(a=fa(d,\nb)))return a;return!1}function ua(c,b,a){for(var d,f=[],m=0,h=c.length;m<h;m++)if(d=new Date(1E3*c[m]),!(b&&d<b||a&&a<d))return d;return 0!==f.length&&f}function ga(c,b,a,d){switch(a=a?new Date(a):new Date,c=parseInt(c),d||(c*=-1),b){case "y":a.setFullYear(a.getFullYear()+c);break;case "M":a.setMonth(a.getMonth()+c);break;case "w":a.i(a.f()+7*c);break;case "d":a.setDate(a.getDate()+c);break;case "h":a.setHours(a.getHours()+c);break;case "m":a.setMinutes(a.getMinutes()+c);break;case "s":a.setSeconds(a.getSeconds()+\nc);break;default:throw Error("invalid time number operator");}return a}function R(c,b){return E(function(a){var d;if(c instanceof Array||(c=[c]),q)var f,m,h;var e=c.slice(0);!function k(){function c(b){d=!!b;q&&(h[h.length-1]+=":",h.push(d),(f=G("_"+m,m))&&h.push("|",f.duration,"ms"),A(h,d?"match":"nomatch","Query"));d?k():a(!1)}var g=e.shift();if(!g)return a(d);"string"==typeof g&&(g={tag:g});g.type=function(a){if(a instanceof Array)return"sub";if("object"==typeof a){for(var b=ha.length,c=0;c<b;c++)if(a[ha[c]])return ha[c];\nif(a.count)return a.count[0].regex?"count_regex":"count";if(a.regex&&"string"==typeof a.regex)return"tag_regex"}throw Error("invalid query type");}(g);q&&(m="q"+ ++wa,G(m),h=[g.type]);var O,I,l,u,n,P,C,x=!1;switch(g.type){case "tag":q&&h.push(JSON.stringify(g.tag));d=fa(g.tag,b);x=!0;break;case "tag_regex":q&&h.push(g.regex);d=va(g.regex,b);x=!0;break;case "url":q&&h.push(g.url);d=function(a,b,c){var d,l;ia||(ia=t[0].length);for(var g=0;g<ia;g++)if(t[0][g]&&(d=t[0][g],-1!==(l=S[a]&&S[a][g]||!1))&&\n(l||(l=b?V(a).test(d[0]):-1!==d[0].indexOf(a),S[a]||(S[a]=[]),S[a][g]=l?1:-1,l))){if(c){var f=c.pathRange||!1,e=void 0!==c.pathOffset&&c.pathOffset;if(f)var h=c.pathDepth||1;if((c.minTime||c.maxTime)&&!ua(d[1],c.minTime,c.maxTime))break;if(f){var n,m=d[1];if(m){var p=0;a:for(;p<f.length;p++){if(-1===h)for(var e=f[p]+1,k=0;k<=m.length;k++)m[k]&&e<k&&(n=k);else for(k=(e=[f[p]+1,f[p]+h])[0];k<=e[1];k++)d[1][k]&&(n=k);if(n&&n)break a}}if(!n)continue;d.path=n}else if(!1!==e){a=0;for(b=d[1].length;a<b;a++)if(d[1][a]>=\ne){tagObj.path=d[1][a];break}if(!tagObj.path)break}}return d.id=g,d}return!1}(g.url,g.regex,b);x=!0;break;case "count":if(q){var p="COUNT( ... )";console.group(p)}b||(b={});b.count=[g.count[1],parseInt(g.count[2])];d=fa(g.count[0],b);x=!0;q&&console.groupEnd(p);break;case "count_regex":q&&(p="COUNT( ... )",console.group(p)),b||(b={}),b.count=[g.count[1],parseInt(g.count[2])],d=va(g.count[0].regex,b),x=!0,q&&console.groupEnd(p)}if(x)c(d);else switch(g.type){case "since":q&&(p="SINCE( ... )",console.group(p));\n(P=g.since,E(function(a,c){"object"!=typeof C&&(C={});var b=P[0];if("object"!=typeof b||!b.time)throw Error("invalid time");b.time instanceof Array&&(b=ga(b.time[0],b.time[1]));C.minTime=b;R(P[1],C).then(function(b){a(!!b)})["catch"](c)})).then(function(a){q&&console.groupEnd(p);c(a)});break;case "path":q&&(p="PATH( ... )",console.group(p));(u=g.path,n=b,E(function(a,b){var c,d,l=[],g=[],f=[];u.forEach(function(a,b){b%2?l.push(a):(g.push(a),f.push(!1))});g.length;"object"!=typeof n&&(n={});var e=\n0;!function D(h){(1E5==++e&&(console.log("aborted path query (>100,000), please file a bug report"),resolvePathQuery()),void 0!==f[h])?((c=g[h],d=l[h-1],n.offset=!1,n.pathOffset=!1,n.pathOperator=!1,f[h]&&(n.offset=f[h]),0<h&&(n.pathOffset=f[h-1],n.pathOperator=d),q)&&A(["#",h,n.offset?"(offset)":"",[{query:c,conditions:n,pathOffset:n.pathOffset,pathOperator:!!n.pathOperator&&n.pathOperator.join("")}],n.offset?{offset:n.offset}:""],"info"),R(c,n).then(function(b){if(f[h]=b,f[h])h++;else{if(0===h)return a(!1);\nh--}D(h)})["catch"](b)):a(!!f[f.length-1])}(0)})).then(function(a){q&&console.groupEnd(p);c(a)});break;case "sub":q&&(p="Sub query ( ... )",console.group(p));R(g,b).then(function(a){q&&console.groupEnd(p);c(a)});break;case "fn":q&&(p="Function query ( ... )",console.group(p));(O=g.fn,I=g.args,l=b,E(function(a,b){var c=Y.push([a,b]);"object"!=typeof l&&(l={});z.postMessage(["fn",[O,I,l,c-1],void 0])})).then(function(a){q&&console.groupEnd(p);c(a)});break;default:throw Error("invalid query type: "+\ng.type);}}()})}function xa(){return Promise.resolve(c);var c}function ka(c,b){return new Promise(function(a,d){var f=b.transaction(c,"readonly"),m=[];f.objectStore(c).openCursor(null,"prev").onsuccess=function(a){a.target.result&&(a.target.result.value&&m.push(a.target.result.value),a.target.result["continue"]&&a.target.result["continue"]())};f.oncomplete=function(){a(m)};f.onerror=function(a){d(a.error)}})}function ya(c){return E(function(b){var a;t[0].forEach(function(d,f){a||d[0]!==c||(b(f),a=\n1)});a||b(!1)})}function la(c){return E(function(b,a){var d=N.transaction("paths","readwrite").objectStore("paths").add({url:c,date:Math.floor(Date.now()/1E3)});d.onsuccess=function(a){b([a.target.result,c])};d.onerror=a})}function Ia(c,b,a){var d=b[0],f=b[1];return E(function(b,h){if(q){var e="tag"+c;G(e)}var m=N.transaction("tags","readwrite").objectStore("tags");if(a){"string"!=typeof a&&(a=JSON.stringify(a));var k=function(a){var b,c,d,g,f=[];a=unescape(encodeURI(a));for(var e=a.length,h=[b=1732584193,\nc=-271733879,~b,~c],m=0;m<=e;)f[m>>2]|=(a.charCodeAt(m)||128)<<m++%4*8;f[a=16*(e+8>>6)+14]=8*e;for(m=0;m<a;m+=16){e=h;for(g=0;64>g;)e=[d=e[3],(b=0|e[1])+((d=e[0]+[b&(c=e[2])|~b&d,d&b|~d&c,b^c^d,c^(b|~d)][e=g>>4]+(za[g]+(0|f[[g,5*g+1,3*g+5,7*g][e]%16+m])))<<(e=[7,12,17,22,5,9,14,20,4,11,16,23,6,10,15,21][4*e+g++%4])|d>>>32-e),b,c];for(g=4;g;)h[--g]=h[g]+e[g]}for(a="";32>g;)a+=(h[g>>3]>>4*(1^7&g++)&15).toString(16);return a}(a)}var w=Math.floor(Date.now()/1E3),g={tag:c,path:d,date:w};a&&(g.data=a,g.b=\nk);m=m.add(g);m.onsuccess=function(){if(q)var a=["tag",JSON.stringify(c)];if(c in t[1]?(t[1][c][0].unshift(d),t[1][c][1].unshift(w),-1===t[1][c][2].indexOf(f)&&t[1][c][2].unshift(f),q&&a.push("updated",[{count:t[1][c][1].length,j:t[1][c][2].length,first:new Date(1E3*t[1][c][1][t[1][c][1].length-1]),g:new Date(1E3*t[1][c][1][1])}])):(t[1][c]=[[d],[w],[f]],q&&a.push("added")),q){var g=G("_"+e,e);g&&a.push(g.duration,"ms");A(a,0,"DB")}b()};m.onerror=h})}var q,v=[];Date.now||(Date.now=function(){return(new Date).getTime()});\nfor(var T=z.performance,na={},U={},za=[],ma=0;64>ma;)za[ma]=0|4294967296*Math.abs(Math.sin(++ma));var Da=RegExp("^\\\\/(.*)\\\\/([gimuy]+)?$",void 0),da={},K={whitespace:/^([ \\t])+$/,method:RegExp("^(url|path|fn|count|regex|page|since)?\\u2090(\\\\d+)\\u209c$","i"),path_operator:RegExp("^(\\\\|)?(\\\\>|\\\\<|=)(=)?((\\\\d+(\\\\.)?(\\\\d+)?)?(y|M|w|d|h|m|s)?)?$",void 0),count_operator:RegExp("^(\\\\>|\\\\<|\\\\=|\\\\<\\\\=|\\\\>\\\\=)$",void 0),str:RegExp(\'^"([^"]|\\\\\\\\")+"$\',void 0),and:/^\\+$/,or:/^\\|$/,comma:/^,$/,fn_args_bool:/^(null|true|false)$/i,\noperator:/^(\\>|\\<|\\=)$/,num:/^(\\d+)(\\.)?(\\d+)?$/,time:/^(\\d+(\\.)?(\\d+)?)(y|M|w|d|h|m|s)$/,date:/^(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2})$/},X={base:["whitespace","str","and","or","method"],path:["whitespace","str","method","path_operator"],fn_args:["whitespace","str","num","comma","fn_args_bool"],url_page:["whitespace","method"],page:["whitespace","str","and","or","method"],count:["whitespace","str","count_operator","num"],since:"whitespace comma str time date method".split(" ")},Z={global:["whitespace",\n"and"],fn_args:[]},Aa={base:"regex url fn path sub since count".split(" "),path:["regex","sub","count","url"],url_page:["page"],page:["regex"],count:["whitespace","str"],since:["sub","regex","url","path","fn"]},aa=(Z={global:["whitespace","and"],fn_args:[]},/^\\n/),Ja=RegExp("^(url|path|fn|count|regex|page|since)?\\u2090(\\\\d+)\\u209c","i"),ba=RegExp("^(\\\\|)?(\\\\>|\\\\<|=)(=)?((\\\\d+(\\\\.)?(\\\\d+)?)?(y|M|w|d|h|m|s)?)?",void 0),Ba=RegExp(\'^"([^"]|\\\\\\\\")+"\',void 0),Ka=/^\\s*"[$A-Z_][0-9A-Z_$]*(\\.[$A-Z_][0-9A-Z_$]*)*"\\s*$/i,\nqa=/\\(([^\\(\\)]|\\\\\\)|\\\\\\()*?\\)/,ea=RegExp("\\u2090(\\\\d+)\\u209c",void 0),Ga=RegExp("\\u2090(\\\\d+)\\u209c\\\\s*",void 0),Fa=RegExp("\\u2090(\\\\d+)\\u209c","g"),Ha=/(^\\(|\\)$)/g,pa=/regex\\s*\\((?!\\u2071)\\s*(\\/?([^\\/]|\\\\\\/)*\\/?[a-z]*)\\s*\\)/,Ea=/regex\\s*(\\(\\s*\\/([^\\/]|\\\\\\/)*)?$/,L={};Object.keys(X).forEach(function(c){L[c]||(L[c]=[]);L[c].push(Ja);-1!==["base","path","fn"].indexOf(c)&&L[c].push(Ba);"path"===c&&L[c].push(ba)});var M=[],ta=0;oa.prototype.parse=function(c,b,a,d,f){var m=this;b||(b="base");for(d||(f=\nd=1);aa.test(c);)d++,f=1,c=c.replace(aa,"");return new Promise(function(h,e){a||(a=[]);var r=[];if(!c.length)return h(a);var k,w=-1;if(b in L&&L[b]&&L[b].forEach(function(a){(a=c.match(a))&&W(a[0],b)&&(k=a[0],w=k.length-1)}),!k)for(var g,q=c.length,I=0;I<q;I++){if((g=I+2)<=q){if(W(g=c.substring(0,g),b))continue;g=g.substring(0,g.length-1)}else g=c.substring(0,I+1);if(W(g,b)){w=I;break}}if(-1===w){var r=c,l=c.indexOf("\\n");-1!==l&&(r=c.substring(0,l));var l=r,u=c.indexOf("\\u2090");-1!==u&&(l=c.substring(0,\nu));/^[^\\s]+\\s/.test(l)&&(l=l.split(/\\s/)[0]);var n=r.indexOf(l);if(-1!==n){var t=m.string.substring(0,n).split("\\n"),C=d+(t.length-2),x=C+(m.string.substring(n,n+l.length).split("\\n").length-1),p=f+(n-1);t.forEach(function(a,b){b<t.length-1&&(p-=a.length)});var Q=c.substring(n,n+l.length).split("\\n"),z=p+l.length;Q.forEach(function(a,b){b<Q.length-1&&(z-=a.length)})}if(-1<u&&!l&&(v=r.match(ea))&&(J=parseInt(v[1]),!isNaN(J)&&m.a[J]))throw new H("Sub query is not allowed here",C,p,x,z+m.a[J][3]);throw new H("Failed to parse ("+\nb+") "+l,C,p,x,z);}k||(k=c.substring(0,w+1));var B=W(k,b);if(!B)throw new H("Parser error (token not found). Please contact the admin. "+JSON.stringify(c));C=k.length;if(!(-1!==Z.global.indexOf(B)||b in Z&&-1!==Z[b].indexOf(B))){x=f-1+k.length;switch(B){case "str":try{var G=ra(k);a.push(G)}catch(ja){l=ja.message}break;case "or":a.push("|");break;case "count_operator":a.push(k);break;case "path_operator":var A;((D=k.match(ba))&&(A=(D[1]||"")+(D[2]||"")),A||(l="Invalid path operator: "+k),l)||(u=D[4]||\n"",(F=u.match(K.time))?(n=F[4],("."===(F=F[1].toString()).substring(F.length-1,F.length)||isNaN(parseFloat(F)))&&(l="Invalid time: "+u),u=!1):"|<"===A?l="Invalid path operator. The same-page less-than operator is only valid with a time depth.":""!==u?(u=-1===u.indexOf(".")&&parseInt(u),isNaN(u)||1>u?l="Invalid navigation path depth.":"|"===D[1]&&(l="Same-page operator cannot contain navigation path depth.")):(u=!1,"<"===A&&(l="Invalid path operator. The less-than operator is not valid without a path depth.")));\nl||(v=[A],F?v.push(F,n):!1!==u&&v.push(u),a.push(v));break;case "method":if(D=k.match(K.method))if(B=D[1]?D[1].toLowerCase():"sub",Aa[b]&&-1!==Aa[b].indexOf(B)){var v,J=-1;if((v=k.match(ea))&&(J=parseInt(v[1])),v&&!isNaN(J)&&m.a[J]){var y=a.push(null)-1;r.push(new Promise(function(b,c){function d(c){a[y]=c;b()}var g=m.a[J][0],l=m.a[J][1],e=m.a[J][2]+2,f="base";switch(B){case "regex":f=V(g=g.trim(),!0);if(!0!==f)throw new H(f,l-1,e-1,l-1,e-1+g.length);return a[y]={regex:g},b();case "url":var h=g.indexOf(",");\nif(-1!==h){var k=g,f="url_page",n=g.split(",");a[y]={url:n[0]};n.shift();g=n.join(",");d=function(c){a[y].funnel=c;b()}}else a[y]={url:g.trim()};if("location"!==a[y].url)if(!0===V(a[y].url))a[y].regex=!0;else{try{var w=ra(a[y].url)}catch(La){throw new H(La.message,l-1,e-1,l-1,e-1+a[y].url.length);}a[y].url=w}if(-1===h)return b();break;case "fn":h=function(a){var b,c=!1,d=a.length;if(Ka.test(a)){try{"string"!=typeof(a=JSON.parse(a))&&(b=\'Not a JSON string (" ... ")\')}catch(Ma){b=Ma.message}c=!0}if(!c||\nb)throw b||(b=a),new H("Invalid function name: "+b,l-1,e-1,l-1,e-1+d);return a};if(-1===g.indexOf(","))return p=h(g),a[y]={fn:p},b();var k=g,f="fn_args",p=h((n=g.split(","))[0]),e=e+(p.length+1);a[y]={fn:p};n.shift();g=n.join(",");d=function(c){a[y].args=[];var d=!0;c.forEach(function(b){if(","===b)d&&a[y].args.push(void 0),d=!0;else{if(!d)throw new H("Invalid function arguments: "+n.join(","),l-1,e-1,l-1,e-2+(k.length-p.length));d=!1;Ba.test(b)&&(b=JSON.parse(b));a[y].args.push(b)}});b()};break;\ncase "path":case "count":case "since":case "page":f=B,d=function(c){switch(a[y]={},B){case "path":for(var d=0,f=c.length;d<f;d++)if(d%2){if(!ba.test(c[d])){k=1;break}}else if(ba.test(c[d])){k=2;break}if(!(k||f%2)){if(k=c[c.length-1]instanceof Array?c[c.length-1].join(""):c[c.length-1]||"")var h=e+g.replace(/\\s+$/g,"").length-k.length-1,m=h+k.length,k="Query missing after path operator.";else k=!1;if(k)throw new H(k,l-1,h,l-1,m);}if(k)throw new H(1===k?"Path operator(s) missing.":"Path operator has invalid position.",\nl-1,e-1,l-1,e+g.length-1);break;case "since":0===c.length?k="Empty query":"object"!=typeof c[0]||!c[0].time&&!c[0].date?k="First parameter should be time or date query":","!==c[1]||3!==c.length?k="Invalid SINCE parameters":c[2]&&0!==c[2].length||(k="SINCE query missing.",-1!==g.indexOf(",")&&(d=e-1+g.length));if(k)throw d||(d=e-1),f||(f=e+g.length),new H(k,l-1,d,l-1,f);c=[c[0],c[2]];break;case "count":if(0===c.length?k="Empty query":"string"==typeof c[0]||"object"==typeof c[0]&&c[0].regex&&!c[0].url?\n"number"!=typeof c[2]&&(k="Invalid COUNT operator number"):k="First parameter should be tag string or tag regex",k)throw new H(k,l-1,e-1,l-1,e+g.length);c=[c[0],c[1],c[2]]}a[y][B]=c;b()}}m.parse(g,f,[],l,e).then(d)["catch"](c)}))}else l="Paranthesis reference not found "+k}else l=B.toUpperCase()+" method not allowed here ("+b+")",x=f-1+B.length;else l="Failed to parse method: "+k;break;case "count":a.push({count:parseInt(k.toString().replace(B,"").replace(/[\\(|\\)|:]/g,""))});break;case "operator":a.push(B);\nbreak;case "num":"."===k.substring(k.length-1,k.length)||isNaN(parseFloat(k))?l="Invalid number: "+k:a.push(parseFloat(k));break;case "time":var F;(D=k.match(K.time))||(l="Invalid time number: "+k);("."===(F=D[1].toString()).substring(F.length-1,F.length)||isNaN(parseFloat(F)))&&(l="Invalid number: "+F,x=F.length);a.push({time:[D[1],D[4]]});break;case "date":var D;(D=k.match(K.date))||(l="Invalid date: "+k);a.push({date:D[1].toString()});break;case "fn_args_bool":try{a.push(JSON.parse(k))}catch(ja){l=\n"Invalid function argument: "+ja.message}break;case "comma":a.push(",")}if(l)throw new H(l,d-1,f-1,d-1,x);}var E=c.substring(w+1);aa.test(E)?(d++,f=1,E=E.replace(aa,"")):f+=C;Promise.all(r).then(function(){E.length?m.parse(E,b,a,d,f).then(function(a){h(a)})["catch"](e):h(a)})["catch"](e)})};var ia,S={},Y=[],t,N,ha=["tag","since","path","url","fn"];if(q)var wa=0;var Na=z.indexedDB||z.webkitIndexedDB||z.mozIndexedDB,ca=[];v[1]=function(c,b){var a,d,f,m;if("boolean"!=typeof b[0]){d=b[0].match(K.time);\nif(!d)throw Error("Invalid time format: "+b[0]+". Format: N(y|M|w|d|h|m|s), e.g. 10m (10 minutes).");d=ga(d[1],d[4])}else a=!b[0];q=!!b[1];(f=a,m=d,t?Promise.resolve(t):new Promise(function(a){if(q){var c="db";G(c)}var b=Na.open("funnelql",1);b.onupgradeneeded=function(a){var c=b.result;1>a.oldVersion&&(c.createObjectStore("urls",{keyPath:"id",autoIncrement:!0}).createIndex("url","url",{unique:!0}),c.createObjectStore("tags",{keyPath:"id",autoIncrement:!0}),c.createObjectStore("paths",{keyPath:"id",\nautoIncrement:!0}))};b.onsuccess=function(){function d(b){if(b||(b=[[],[]]),t=b,q){b=["loaded"];var d=G("_"+c,c);d&&b.push(d.duration,"ms");A(b,0,"DB")}if(ca.length)for(b=ca.shift();b;)b(t),b=ca.shift();a(t)}N=b.result;if(f)return q&&A(["expired",{h:!0}],0,"DB"),xa().then(d);Promise.all([ka("urls",N).then(function(a){var b=[];return a.forEach(function(a){b[a.id]=[a.url,[],[]]}),b}),ka("tags",N).then(function(a){var b=[],c=[],d=[];return a.forEach(function(a){if(b[a.tag]||(b[a.tag]=[[],[],[]]),b[a.tag][0].push(a.path),\nb[a.tag][1].push(a.date),a.data){if(d[a.path]||(d[a.path]={}),d[a.path][a.tag]||(d[a.path][a.tag]={}),!d[a.path][a.tag][a.b]){var g,e=a.data;if(-1!==["{","["].indexOf(a.data.substring(0,1)))try{g=JSON.parse(a.data)}catch(P){g=!1}e=g||e.toString();d[a.path][a.tag][a.b]=[e,[],[]]}-1===d[a.path][a.tag][a.b][1].indexOf(a.date)&&(d[a.path][a.tag][a.b][1][a.path]=a.date)}c[a.path]||(c[a.path]=[]);c[a.path].push(a.tag)}),[b,c,d]}),ka("paths",N)]).then(function(a){var b,c=a[0],e=a[1][0],f=a[1][1],h=a[1][2],\nk={},r;for(r in a[2].forEach(function(a){(!b||b<a.date)&&(b=a.date);c[a.url]&&(c[a.url][1].push(a.id),c[a.url][2].push(a.date));f[a.id]&&f[a.id].forEach(function(b){if(-1===e[b][2].indexOf(a.url)&&e[b][2].push(a.url),h[a.id]&&h[a.id][b])for(var c in e[b][3]||(e[b][3]=[]),h[a.id][b])h[a.id][b].hasOwnProperty(c)&&(e[b][3][c]||(e[b][3][c]=h[a.id][b][c]),e[b][3][c][2][a.url]||(e[b][3][c][2][a.url]=[]),-1===e[b][3][c][2][a.url].indexOf(a.date)&&e[b][3][c][2][a.url].push(a.date))})}),e)if(e.hasOwnProperty(r)){if(e[r][3]){a=\n[];for(var t in e[r][3])e[r][3].hasOwnProperty(t)&&a.push(e[r][3][t]);e[r][3]=a}k[r]=e[r]}b&&(b=new Date(1E3*b));b&&b<m?(q&&A(["expired",{date:b,c:m}],0,"DB"),xa().then(d)):d([c,k])})}})).then(function(){z.postMessage([c,void 0,void 0])})["catch"](function(a){throw a;})};v[2]=function(c,b){function a(a){if(q){var h;(t[0].forEach(function(a){h||a[0]!==b||(h=a)}),h)&&f.push({visits:h[1].length});var e=G("_"+d,d);e&&f.push(e.duration,"ms");A(f,0,"DB")}z.postMessage([c,a,void 0])}if(q){var d="url"+b;\nG(d);var f=["nav"]}ya(b).then(function(c){c?(q&&(!0,f.push("url updated")),la(c).then(a)):(f.push("url added"),E(function(a,c){var d=N.transaction("urls","readwrite").objectStore("urls").add({url:b});d.onsuccess=function(b){var d=b.target.result;la(d).then(function(b){a([b,d])})["catch"](c)};d.onerror=function(d){var e=d.target.error.toString();-1!==e.indexOf("unique")?ya(b).then(function(b){b?la(b).then(function(c){a([c,b])}):(console.error(e),c(e))}):(console.error(e),c(e))}}).then(a))})};v[3]=\nfunction(c,b){Ia(b[0],b[1],b[2]).then(function(){z.postMessage([c,void 0,void 0])})};v[5]=function(c,b){q=!!b};v[6]=function(c,b){var a=b[0],d=b[1];if(Y[a]){var f=Y[a][0];Y[a]=!1;f(d)}!0};v[7]=function(c){z.postMessage([c,t,void 0])};v[8]=function(c,b){function a(a,b){if(q){console.groupEnd(d);var e=G("_"+f,f);e&&m.push(e.duration,"ms");A(m)}z.postMessage([c,!!a,b])}if(q){var d="Funnel Query"+("string"==typeof b?": "+b:""),f="q"+ ++wa;G(f);var m=["query"];console.groupCollapsed(d)}"string"==typeof b?\nsa(b).then(function(b){R(b).then(function(b){a(b)})["catch"](function(b){a(!1,b)})})["catch"](function(b){a(!1,b)}):a(R(b))};v[9]=function(c,b){sa(b).then(function(a){z.postMessage([c,a,void 0])})["catch"](function(a){z.postMessage([c,!1,a])})};z.onmessage=function(c){if(!c.data[0])throw Error("invalid FunnelQL Database command");var b,a=c.data[0].toString(),d=c.data[1].toString(),f=c.data[2];v[a]&&(1<a?(b=function(){v[a](d,f)},t?b(t):ca.push(b)):v[a](d,f))}}(self);\n'))}catch(a){console.error(a)}v.addEventListener("message",
function(a){a.data&&a.data[0]&&h.c(a.data[0],a.data[1],a.data[2])});v.addEventListener("error",function(a){console.error("FunnelQL Worker:",a)});h.on("fn",function(a){function b(a){p(6,function(){},[m,a])}var e,d=a[0],c=a[1]||[];a[2]&&c.push(a[2]);var m=a[3];try{if(-1!==d.indexOf(".")){a=l;for(var h=dotFn.split("."),n=h.pop(),d=0;d<h.length;d++)a=a[h[d]];e=a[n].apply(l,c)}else{if(!l[d])throw Error(d+" is not a function");e=l[d].apply(l,c)}e instanceof Promise?e.then(function(a){b(a)}):b(e)}catch(k){t&&
D(["function query failed",k],"error"),b(!1)}});var w=document.createElement("a");h.on("load",function(){A(document.location.toString()).then(function(a){u=a})});n.init=function(a){return function(a){if("object"!=typeof a)throw Error("Invalid config.");a.g||(a.g="session");var b=[];"session"===a.g?b[0]=!!sessionStorage.getItem("funnelql"):"never"===a.g?b[0]=!0:b[0]=a.g;p(1,function(){C=1;h.c("load");"session"===a.g&&sessionStorage.setItem("funnelql",1)},b)}(a),this};n.parse=function(a){return new Promise(function(b,
e){p(9,function(a,c){c?e(new z(c[1],c[2],c[3],c[4],c[5])):b(a)},a)})};n.query=function(a){return new Promise(function(b,e){p(8,function(a,c){c?e(new z(c[1])):b(a)},a)})};n.tag=function(a,b){return new Promise(function(e){(u?Promise.resolve(u):new Promise(function(a){h.b("path",function(b){a(u=b)})})).then(function(d){p(3,function(){h.c("u");e()},[a,d,b])})})};n.nav=A;n.db=function(a){h.on("load",function(){p(7,a)})};n.on=function(a,b){return function d(a,b,l){var c=[];switch(a){case "load":if(C)return b?
b():Promise.resolve(void 0);break;default:var k=a;if(k instanceof Array){if(!b)throw Error("Cannot use multi-query with a promise. Use a callback.");return void k.forEach(function(a){d(a.toString(),b)})}var m=q.indexOf(k);-1===m&&(m=q.push(k)-1);c.push([function(a,b){n.query(b).then(function(c){c&&(h.c(a,c,b),y(b))})},k]);a="q"+m}if(l=b?(l?h.on(a,b):h.b(a,b),this):new Promise(function(b){h.b(a,b)}),c.length)for(k=c.shift();k;)k[0].apply(this,[a].concat(k[1])),k=c.shift();return l}(a,b)};n.off=function(a,
b){switch(a){case "load":h.off(a,b);break;default:var e=q.indexOf(a);-1!==e&&h.off("q"+e,b)}return this};n.debug=function(a){t!==(a=!!a)&&((t=a)&&D(["debug enabled"],"warn"),p(5,function(){},t))};window.$FQL=n}else console.error("FunnelQL is not supported by your browser.")}(window);
